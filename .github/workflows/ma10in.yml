name: ZeroTier-RDP-Fixed

on:
  workflow_dispatch:
    inputs:
      deployment_region:
        description: 'Select deployment region'
        required: false
        default: 'default'

jobs:
  zt-remote-access:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: enable-and-configure-rdp
        run: |
          Write-Host "ุชููุฆุฉ RDP ุจุดูู ูุงูู..."
          
          # ุชูุนูู RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force
          
          # ุฅุนุฏุงุฏ NLA (Network Level Authentication) - ููู ููุงุชุตุงู ุงูุขูู
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 1 -Force
          
          # ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ ูุชุญุณูู ุงูุงุชุตุงู
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fSingleSessionPerUser" -Value 0 -Force
          
          # ุฌุฏุงุฑ ุงูุญูุงูุฉ
          netsh advfirewall firewall delete rule name="RemoteDesktop" 2>$null
          netsh advfirewall firewall delete rule name="ZeroTier-RDP" 2>$null
          
          netsh advfirewall firewall add rule name="RemoteDesktop-TCP" `
            dir=in action=allow protocol=TCP localport=3389 `
            description="Allow RDP TCP"
            
          netsh advfirewall firewall add rule name="RemoteDesktop-UDP" `
            dir=in action=allow protocol=UDP localport=3389 `
            description="Allow RDP UDP"
          
          # ุฅุนุงุฏุฉ ุงูุฎุฏูุงุช
          Restart-Service TermService -Force
          Start-Service SessionEnv -ErrorAction SilentlyContinue
          
          Write-Host "ุชู ุฅุนุฏุงุฏ RDP ุจุงููุงูู โ"

      - name: create-secure-user
        run: |
          # ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ ุฃูุซุฑ ุฃูุงูุงู
          $username = "RemoteUser"
          $password = "P@ssw0rd!2024"
          
          # ุญุฐู ุงููุณุชุฎุฏู ุฅุฐุง ููุฌูุฏ
          $existing = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
          if ($existing) {
              Remove-LocalUser -Name $username -Confirm:$false
          }
          
          # ุฅูุดุงุก ุงููุณุชุฎุฏู
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePass `
                       -FullName "Remote Access User" `
                       -Description "For remote desktop connections" `
                       -AccountNeverExpires
          
          # ุฅุถุงูุฉ ูููุฌููุนุงุช
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          # ุฅุนุฏุงุฏ ุญุณุงุจ ููุงุชุตุงู ุงูุชููุงุฆู
          Set-LocalUser -Name $username -PasswordNeverExpires $true
          
          echo "RDP_USER=$username" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV
          
          Write-Host "ุชู ุฅูุดุงุก ุงููุณุชุฎุฏู: $username"

      - name: install-zerotier-enhanced
        run: |
          Write-Host "ุชุซุจูุช ZeroTier ูุน ุฅุนุฏุงุฏุงุช ูุญุณูุฉ..."
          
          # ุฅุฒุงูุฉ ุฃู ูุณุฎุฉ ูุฏููุฉ
          Get-Service -Name "ZeroTier OneService" -ErrorAction SilentlyContinue | Stop-Service -Force
          
          # ุชุญููู ZeroTier
          $zt_url = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
          $zt_path = "$env:TEMP\ZeroTier.msi"
          
          Invoke-WebRequest -Uri $zt_url -OutFile $zt_path -UseBasicParsing
          
          # ุงูุชุซุจูุช ูุน ุฎูุงุฑุงุช ูุงููุฉ
          Start-Process msiexec.exe -ArgumentList @(
            "/i",
            "`"$zt_path`"",
            "/quiet",
            "/norestart",
            "ADDLOCAL=ZTApi,ZTCli,ZTService,ZTUi"
          ) -Wait -NoNewWindow
          
          Remove-Item $zt_path -Force
          
          # ุจุฏุก ุงูุฎุฏูุฉ
          Start-Service -Name "ZeroTier OneService" -ErrorAction SilentlyContinue
          Set-Service -Name "ZeroTier OneService" -StartupType Automatic
          
          Write-Host "ุชู ุชุซุจูุช ZeroTier โ"

      - name: configure-zerotier-network
        run: |
          Write-Host "ุฅุนุฏุงุฏ ุดุจูุฉ ZeroTier..."
          
          $zt_cli = "C:\Program Files (x86)\ZeroTier\One\zerotier-cli.bat"
          $network_id = "${{ secrets.ZEROTIER_NETWORK_ID }}"
          
          if (-not $network_id -or $network_id -eq "") {
              Write-Error "โ ูู ูุชู ุชุนููู ZEROTIER_NETWORK_ID ูู Secrets"
              exit 1
          }
          
          Write-Host "Network ID: $network_id"
          
          # ุงูุงูุถูุงู ููุดุจูุฉ
          & $zt_cli join $network_id
          Start-Sleep -Seconds 3
          
          # ุงูุญุตูู ุนูู ูุนุฑู ุงูุฌูุงุฒ
          $device_info = & $zt_cli info
          $device_id = ($device_info | Select-String "info").Line.Split()[2]
          
          echo "ZT_DEVICE_ID=$device_id" >> $env:GITHUB_ENV
          Write-Host "Device ID: $device_id"
          
          # ุงูุชุธุงุฑ ุงูุงุชุตุงู
          Write-Host "ุฌุงุฑู ุงูุงุชุตุงู ุจุงูุดุจูุฉ..."
          $connected = $false
          $attempts = 0
          
          while (-not $connected -and $attempts -lt 30) {
              $status = & $zt_cli listnetworks
              
              if ($status -match "OK") {
                  $lines = $status -split "`n"
                  foreach ($line in $lines) {
                      if ($line -match "$network_id.*?(\d+\.\d+\.\d+\.\d+)/\d+") {
                          $ip = $matches[1]
                          echo "ZT_IP=$ip" >> $env:GITHUB_ENV
                          Write-Host "โ ุญุตู ุนูู IP: $ip"
                          $connected = $true
                          break
                      }
                  }
              }
              
              if (-not $connected) {
                  $attempts++
                  Write-Host "โณ ูุญุงููุฉ $attempts/30 - ูู ุงูุชุธุงุฑ ุงูููุงููุฉ..."
                  Start-Sleep -Seconds 5
              }
          }
          
          if (-not $connected) {
              Write-Host "โ๏ธ  ูู ูุญุตู ุนูู IP ุจุนุฏ"
              Write-Host "๐ ุงูุฑุฌุงุก ุงูููุงููุฉ ุนูู ุงูุฌูุงุฒ ููุง:"
              Write-Host "https://my.zerotier.com/network/$network_id"
              Write-Host "๐ Device ID: $device_id"
          }

      - name: test-rdp-connection
        run: |
          Write-Host "ุงุฎุชุจุงุฑ ุงุชุตุงู RDP..."
          
          # ุฅูุดุงุก ููู ุงุฎุชุจุงุฑ ุงุชุตุงู
          $test_script = @"
@echo off
echo ุงุฎุชุจุงุฑ ุงุชุตุงู RDP
echo =================
echo.
echo 1. ุชุญูู ูู ุฎุฏูุฉ RDP
sc query TermService
echo.
echo 2. ุชุญูู ูู ูููุฐ 3389
netstat -an | findstr :3389
echo.
echo 3. ุฅุนุฏุงุฏุงุช ุงููุณุชุฎุฏู
net user $env:RDP_USER
echo.
echo 4. ุนููุงู ZeroTier
"@
          
          $test_script | Out-File -FilePath "C:\RDP_Test.txt" -Encoding ASCII
          
          if ($env:ZT_IP) {
              "echo ZeroTier IP: $env:ZT_IP" | Out-File -FilePath "C:\RDP_Test.txt" -Append -Encoding ASCII
          } else {
              "echo ZeroTier IP: ูู ุงูุชุธุงุฑ ุงูููุงููุฉ" | Out-File -FilePath "C:\RDP_Test.txt" -Append -Encoding ASCII
          }
          
          Write-Host "ุชู ุฅูุดุงุก ููู ุงุฎุชุจุงุฑ ูู C:\RDP_Test.txt"

      - name: install-remote-tools
        run: |
          Write-Host "ุชุซุจูุช ุฃุฏูุงุช ูุณุงุนุฏุฉ..."
          
          $desktop = "C:\Users\Public\Desktop"
          
          # 1. AnyDesk (ุจุฏูู ูู RustDesk)
          $anydesk_url = "https://download.anydesk.com/AnyDesk.exe"
          $anydesk_path = "$desktop\AnyDesk.exe"
          Invoke-WebRequest -Uri $anydesk_url -OutFile $anydesk_path -UseBasicParsing
          
          # 2. ุฅูุดุงุก ููู ุฅุฑุดุงุฏุงุช
          $guide = @"
# ุฅุฑุดุงุฏุงุช ุงูุงุชุตุงู
==================

## 1. ุงุชุตุงู ZeroTier:
- ุณุฌู ุงูุฏุฎูู: https://my.zerotier.com
- ุงูุดุจูุฉ: ${{ secrets.ZEROTIER_NETWORK_ID }}
- ุงูุฌูุงุฒ: $env:ZT_DEVICE_ID
- ุถุน โ ุนูู ุงูุฌูุงุฒ ุซู ุงูุชุธุฑ 30 ุซุงููุฉ

## 2. ุจูุงูุงุช ุงูุงุชุตุงู:
- ุงูุนููุงู: $env:ZT_IP
- ุงููุณุชุฎุฏู: $env:RDP_USER
- ูููุฉ ุงููุฑูุฑ: $env:RDP_PASS

## 3. ุฅุฐุง ูุดู RDP:
- ุงูุชุญ AnyDesk.exe ุนูู ุณุทุญ ุงูููุชุจ
- ุงุณุชุฎุฏู ุฑูู AnyDesk ููุงุชุตุงู

## 4. ุงุณุชูุดุงู ุงูุฃุฎุทุงุก:
- ุงูุชุญ C:\RDP_Test.txt ูููุนูููุงุช
"@
          
          $guide | Out-File -FilePath "$desktop\ReadMe_Connection.txt" -Encoding UTF8
          
          Write-Host "ุชู ุชุซุจูุช ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ โ"

      - name: final-status-check
        run: |
          Write-Host ""
          Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          Write-Host "๐  ุฅุนุฏุงุฏ RDP ุนุจุฑ ZeroTier ููุชูู"
          Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          Write-Host ""
          
          if ($env:ZT_IP) {
              Write-Host "โ  ุงูุนููุงู ุงูููุงุฆู: $env:ZT_IP"
              Write-Host "๐ค  ุงููุณุชุฎุฏู: $env:RDP_USER"
              Write-Host "๐  ูููุฉ ุงููุฑูุฑ: $env:RDP_PASS"
              Write-Host ""
              Write-Host "๐ก  ููููู ุงูุงุชุตุงู ุงูุขู ุนุจุฑ Remote Desktop"
          } else {
              Write-Host "โ๏ธ  ูู ุงูุชุธุงุฑ ุงูููุงููุฉ ุนูู ุงูุฌูุงุฒ"
              Write-Host ""
              Write-Host "๐  ุงุฐูุจ ุฅูู: https://my.zerotier.com"
              Write-Host "๐  Network ID: ${{ secrets.ZEROTIER_NETWORK_ID }}"
              Write-Host "๐  Device ID: $env:ZT_DEVICE_ID"
              Write-Host ""
              Write-Host "1. ุณุฌู ุงูุฏุฎูู ุฅูู ZeroTier"
              Write-Host "2. ุงุฎุชุฑ ุดุจูุชู"
              Write-Host "3. ุงุจุญุซ ุนู ุงูุฌูุงุฒ: $env:ZT_DEVICE_ID"
              Write-Host "4. ุถุน โ ูู ุนููุฏ Auth"
              Write-Host "5. ุงูุชุธุฑ 30 ุซุงููุฉ"
              Write-Host "6. ุฃุนุฏ ุชุดุบูู ุงูู Workflow"
          }
          
          Write-Host ""
          Write-Host "โณ  ุงูุฌูุณุฉ ุณุชุจูู ูุดุทุฉ ููุฏุฉ 6 ุณุงุนุงุช"
          
          # ุนุฑุถ ุชุญุฏูุซ ุฏูุฑู
          $hours = 6
          $startTime = Get-Date
          
          for ($i = 1; $i -le ($hours * 12); $i++) {
              $elapsed = (Get-Date) - $startTime
              $remaining = New-TimeSpan -Minutes ($hours * 60) - $elapsed
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] โฑ๏ธ  ูุชุจูู: $($remaining.ToString('hh\:mm'))"
              
              # ุชุญุฏูุซ ุญุงูุฉ ZeroTier ูู 5 ุฏูุงุฆู
              if ($i % 5 -eq 0 -and -not $env:ZT_IP) {
                  $zt_cli = "C:\Program Files (x86)\ZeroTier\One\zerotier-cli.bat"
                  $status = & $zt_cli listnetworks 2>$null
                  if ($status -match "(\d+\.\d+\.\d+\.\d+)") {
                      $new_ip = $matches[1]
                      Write-Host "๐  ุชู ุงูุญุตูู ุนูู IP ุฌุฏูุฏ: $new_ip"
                      echo "ZT_IP=$new_ip" >> $env:GITHUB_ENV
                  }
              }
              
              Start-Sleep -Seconds 300  # 5 ุฏูุงุฆู
          }
          
          Write-Host "โฐ  ุงูุชูุช ูุฏุฉ ุงูุฌูุณุฉ"
